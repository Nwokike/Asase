{% extends 'base.html' %}

{% block title %}Map - ASASE{% endblock %}

{% block content %}
<div class="h-screen pt-20 md:pt-20 pb-14 md:pb-0 relative">
    <div id="mainMap" class="w-full h-full z-0"></div>
    
    <div class="absolute top-24 left-4 right-4 md:left-8 md:right-auto md:w-96 z-[1000]">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl border border-white/20 p-4">
            <h3 class="text-sm font-semibold text-navy mb-3 flex items-center">
                <i class="bi bi-pin-map text-lg mr-2"></i>
                Click map or search location
            </h3>
            <form hx-post="/analysis/live-report/" 
                  hx-target="#map-analysis-results" 
                  hx-swap="innerHTML"
                  hx-indicator="#map-loading"
                  class="space-y-3">
                {% csrf_token %}
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="map-location"
                        name="location" 
                        class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent text-sm" 
                        placeholder="Search location..."
                        required
                    >
                    <input type="hidden" id="map-country" name="country" value="">
                    <button type="submit" class="bg-navy hover:bg-opacity-90 text-white px-4 py-2 rounded-xl font-medium transition-all text-sm flex items-center" id="mapAnalyzeBtn">
                        <i class="bi bi-search mr-1"></i>
                        <span>Go</span>
                    </button>
                </div>
                <div id="map-loading" class="htmx-indicator text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-gray-300 border-t-navy"></div>
                    <span class="text-gray-600 text-xs ml-2">Analyzing... (may take up to 30 seconds)</span>
                </div>
            </form>
        </div>
    </div>
    
    <div id="map-analysis-results" class="absolute bottom-16 md:bottom-8 left-4 right-4 md:left-8 md:right-8 z-[1001] max-h-[70vh] overflow-y-auto"></div>
    
    <div id="notification" class="hidden fixed top-24 right-4 z-[1100] bg-green-leaf text-white px-6 py-3 rounded-xl shadow-lg transition-all">
        <div class="flex items-center gap-2">
            <i class="bi bi-check-circle-fill text-lg"></i>
            <span class="font-medium">Analysis Complete!</span>
        </div>
    </div>
</div>

<script>
    var map = L.map('mainMap').setView([9.0820, 8.6753], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    map.on('click', function(e) {
        var lat = e.latlng.lat.toFixed(4);
        var lon = e.latlng.lng.toFixed(4);
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
            headers: {'User-Agent': 'ASASE-Environmental-Platform/1.0'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.display_name) {
                var country = data.address?.country || data.display_name.split(',').pop().trim();
                var city = data.address?.city || data.address?.town || data.address?.village || data.address?.state || '';
                var location = city || data.display_name.split(',')[0].trim();
                
                document.getElementById('map-location').value = location;
                document.getElementById('map-country').value = country;
            }
        });
    });
    
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'map-analysis-results') {
            const resultsEl = document.getElementById('map-analysis-results');
            if (resultsEl && resultsEl.children.length > 0) {
                setTimeout(function() {
                    resultsEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    
                    const notification = document.getElementById('notification');
                    notification.classList.remove('hidden');
                    
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Analysis Complete!', {
                            body: 'Your environmental analysis is ready to view.',
                            icon: '/static/images/logo.png'
                        });
                    }
                    
                    setTimeout(function() {
                        notification.classList.add('hidden');
                    }, 4000);
                }, 100);
            }
        }
    });
    
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
</script>
{% endblock %}
