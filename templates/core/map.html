{% extends 'base.html' %}

{% block title %}Map - ASASE{% endblock %}

{% block content %}
<div class="h-screen pt-20 pb-20 md:pb-0">
    <div id="mainMap" class="w-full h-full"></div>
    
    <div class="absolute top-28 left-4 right-4 md:left-8 md:right-auto md:w-96 z-[1000]">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
            <form hx-post="/analysis/live-report/" 
                  hx-target="#map-analysis-results" 
                  hx-swap="innerHTML"
                  hx-indicator="#map-loading"
                  class="space-y-3">
                {% csrf_token %}
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="map-location"
                        name="location" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent text-sm" 
                        placeholder="Search location..."
                        required
                    >
                    <button type="submit" class="bg-navy hover:bg-opacity-90 text-white px-5 py-2 rounded-lg font-medium transition-all text-sm">
                        <i class="bi bi-search icon-sm"></i>
                    </button>
                </div>
                <div id="map-loading" class="htmx-indicator text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-gray-300 border-t-navy"></div>
                    <span class="text-gray-600 text-xs ml-2">Analyzing...</span>
                </div>
            </form>
        </div>
    </div>
    
    <div id="map-analysis-results" class="absolute bottom-24 md:bottom-8 left-4 right-4 z-[1000] max-h-96 overflow-y-auto"></div>
</div>

<script>
    var map = L.map('mainMap').setView([9.0820, 8.6753], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    map.on('click', function(e) {
        var lat = e.latlng.lat.toFixed(4);
        var lon = e.latlng.lng.toFixed(4);
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
            headers: {'User-Agent': 'ASASE-Environmental-Platform/1.0'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.display_name) {
                document.getElementById('map-location').value = data.display_name;
            }
        });
    });
</script>
{% endblock %}
