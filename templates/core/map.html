{% extends 'base.html' %}

{% block title %}Map - ASASE{% endblock %}

{% block content %}
<div class="h-screen pt-16 pb-20 md:pb-0">
    <div id="mainMap" class="w-full h-full"></div>
    
    <div class="absolute top-24 left-4 right-4 md:left-8 md:right-auto md:w-96 z-[1000]">
        <div class="glass-card rounded-2xl p-4">
            <form hx-post="/analysis/live-report/" 
                  hx-target="#map-analysis-results" 
                  hx-swap="innerHTML"
                  hx-indicator="#map-loading"
                  class="space-y-3">
                {% csrf_token %}
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="map-location"
                        name="location" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-60 focus:outline-none focus:border-green-leaf" 
                        placeholder="Search location on map..."
                        required
                    >
                    <button type="submit" class="bg-green-leaf hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-semibold transition-all whitespace-nowrap">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div id="map-loading" class="htmx-indicator text-center py-2">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-white border-t-green-leaf"></div>
                    <span class="text-white text-sm ml-2">Analyzing...</span>
                </div>
            </form>
        </div>
    </div>
    
    <div id="map-analysis-results" class="absolute bottom-24 md:bottom-8 left-4 right-4 z-[1000] max-h-96 overflow-y-auto"></div>
</div>

<script>
    var map = L.map('mainMap').setView([9.0820, 8.6753], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    var markers = [];
    
    map.on('click', function(e) {
        var lat = e.latlng.lat.toFixed(4);
        var lon = e.latlng.lng.toFixed(4);
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
            headers: {'User-Agent': 'ASASE-Environmental-Platform/1.0'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.display_name) {
                document.getElementById('map-location').value = data.display_name;
            }
        });
    });
</script>

<style>
    .htmx-indicator {
        display: none;
    }
    .htmx-request .htmx-indicator {
        display: block;
    }
    #mainMap {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}
